<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <style>
    html, body, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
    }
    /* Style untuk legenda kustom */
    .legend {
        padding: 8px;
        font: 14px Arial, Helvetica, sans-serif;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        line-height: 20px;
        color: #333;
    }
    .legend h4 {
        margin: 0 0 5px;
        color: #111;
        text-align: center;
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        border: 1px solid #555;
    }
    </style>
    <title>Peta Analisis Lahan</title>
</head>
<body>
    <div id="map"></div>
    <script src="js/leaflet.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="data/MayoritasTutupanLahan_1.js"></script>
    <script src="data/IndeksKesesuaianLahanPertanian_2.js"></script>
    <script src="data/BatasKabupaten_4.js"></script>
    <script>
        var map = L.map('map').fitBounds([[-8.292, 109.982], [-7.454, 110.859]]);
        var hash = new L.Hash(map);

        // --- PANE UNTUK URUTAN LAYER ---
        map.createPane('pane_GoogleSatellite');
        map.getPane('pane_GoogleSatellite').style.zIndex = 400;
        map.createPane('pane_TutupanLahan');
        map.getPane('pane_TutupanLahan').style.zIndex = 401;
        map.createPane('pane_KesesuaianLahan');
        map.getPane('pane_KesesuaianLahan').style.zIndex = 402;
        map.createPane('pane_BatasKabupaten');
        map.getPane('pane_BatasKabupaten').style.zIndex = 403;

        // --- BASEMAP ---
        var googleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatellite',
            attribution: 'Google Satellite'
        });
        googleSatellite.addTo(map);

        // --- DEFINISI LAYER ---
        // 1. Batas Kabupaten
        var batasKabupaten = new L.geoJson(json_BatasKabupaten_4, {
            pane: 'pane_BatasKabupaten',
            style: { color: '#000000', weight: 2.5, fill: false }
        });

        // 2. Tutupan Lahan
        var tutupanLahan = new L.geoJson(json_MayoritasTutupanLahan_1, {
            pane: 'pane_TutupanLahan',
            style: function(feature) {
                switch(String(feature.properties['_majority'])) {
                    case '6.0': return { fillColor: '#d7191c', fillOpacity: 0.85, weight: 0 }; // Bangunan
                    case '1.0': return { fillColor: '#1a9641', fillOpacity: 0.85, weight: 0 }; // Hutan
                    case '4.0': return { fillColor: '#fec925', fillOpacity: 0.85, weight: 0 }; // Lahan Pertanian
                    case '5.0': return { fillColor: '#a6d96a', fillOpacity: 0.85, weight: 0 }; // Semak
                }
            }
        });

        // 3. Indeks Kesesuaian Lahan (Layer Utama)
        var kesesuaianLahan = new L.geoJson(json_IndeksKesesuaianLahanPertanian_2, {
            pane: 'pane_KesesuaianLahan',
            style: function(feature) {
                switch(String(feature.properties['Cluster'])) {
                    case 'Tidak Sesuai (N)': return { fillColor: '#d73027', fillOpacity: 0.8, weight: 0.5, color: '#333' };
                    case 'Sesuai Marginal (S3)': return { fillColor: '#fc8d59', fillOpacity: 0.8, weight: 0.5, color: '#333' };
                    case 'Cukup Sesuai (S2)': return { fillColor: '#91cf60', fillOpacity: 0.8, weight: 0.5, color: '#333' };
                    case 'Sangat Sesuai (S1)': return { fillColor: '#1a9850', fillOpacity: 0.8, weight: 0.5, color: '#333' };
                }
            },
            onEachFeature: function(feature, layer) { /* Fungsi popup & highlight dari kode sebelumnya */ }
        });
        kesesuaianLahan.addTo(map); // Langsung aktif saat peta dibuka

        // --- KONTROL LAYER & LEGENDA ---
        var baseMaps = { "Google Satelit": googleSatellite };
        var overlayMaps = {
            "<b>Indeks Kesesuaian Lahan</b>": kesesuaianLahan,
            "Mayoritas Tutupan Lahan": tutupanLahan,
            "Batas Kabupaten": batasKabupaten
        };
        L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);

        // Legenda Kustom untuk kedua layer
        var legend = L.control({position: 'bottomleft'}); // Posisi di kiri bawah
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            var kesesuaianLabels = ['Sangat Sesuai (S1)', 'Cukup Sesuai (S2)', 'Sesuai Marginal (S3)', 'Tidak Sesuai (N)'];
            var kesesuaianColors = ['#1a9850', '#91cf60', '#fc8d59', '#d73027'];
            var tutupanLabels = ['Hutan', 'Semak Belukar', 'Lahan Pertanian', 'Bangunan'];
            var tutupanColors = ['#1a9641', '#a6d96a', '#fec925', '#d7191c'];

            div.innerHTML = '<h4>Kesesuaian Lahan</h4>';
            for (var i = 0; i < kesesuaianLabels.length; i++) {
                div.innerHTML += '<i style="background:' + kesesuaianColors[i] + '"></i> ' + kesesuaianLabels[i] + '<br>';
            }
            div.innerHTML += '<hr style="margin: 5px 0;"><h4>Tutupan Lahan</h4>';
            for (var i = 0; i < tutupanLabels.length; i++) {
                div.innerHTML += '<i style="background:' + tutupanColors[i] + '"></i> ' + tutupanLabels[i] + '<br>';
            }
            return div;
        };
        legend.addTo(map);

    </script>
</body>
</html>
