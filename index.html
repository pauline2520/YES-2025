<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Peta Kesesuaian Lahan Pertanian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <style>
    html, body, #map {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    /* Improved legend styling */
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
      font-size: 12px;
      line-height: 18px;
    }
    
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 1;
      border: 1px solid #777;
    }
    
    .legend h4 {
      margin: 0 0 5px 0;
      font-size: 13px;
      font-weight: bold;
    }
    
    /* Layer control with integrated legends */
    .leaflet-control-layers-expanded {
      padding: 6px 10px;
    }
    
    .layer-legend {
      margin-top: 5px;
      padding: 5px;
      background: rgba(255,255,255,0.8);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="js/leaflet.js"></script>
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet.pattern.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/rbush.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>

  <!-- Data -->
  <script src="data/MayoritasTutupanLahan_1.js"></script>
  <script src="data/IndeksKesesuaianLahanPertanian_2.js"></script>
  <script src="data/BatasKabupaten_4.js"></script>

  <script>
    var map = L.map('map').fitBounds([[-8.2922, 109.9826], [-7.4546, 110.8597]]);
    var hash = new L.Hash(map);

    // Basemap
    var layer_GoogleSatellite_0 = L.tileLayer(
      'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: 'Google Satellite',
        opacity: 1.0
      }).addTo(map);

    // Style default
    var defaultStyle = {
      opacity: 1,
      color: '#232323',
      weight: 1.0,
      fillOpacity: 1.0  // Changed to full opacity
    };

    var highlightStyle = {
      weight: 3,
      color: '#FFFF00',
      fillOpacity: 1.0  // Changed to full opacity
    };

    // ===============================
    // Indeks Kesesuaian Lahan
    // ===============================
    function style_Indeks(feature) {
      switch (feature.properties['Cluster']) {
        case 'Tidak Sesuai (N)': return {...defaultStyle, fillColor: '#D7191C'};
        case 'Sesuai Marginal (S3)': return {...defaultStyle, fillColor: '#FEC980'};
        case 'Cukup Sesuai (S2)': return {...defaultStyle, fillColor: '#C7E8AD'};
        case 'Sangat Sesuai (S1)': return {...defaultStyle, fillColor: '#2B83BA'};
        default: return {...defaultStyle, fillColor: '#888888'};
      }
    }

    function onEach_Indeks(feature, layer) {
      var props = feature.properties;
      var popupContent = `
        <table>
          <tr><th>Cluster</th><td>${props['Cluster']}</td></tr>
          <tr><th>Desa</th><td>${props['NAMOBJ']}</td></tr>
          <tr><th>Kabupaten</th><td>${props['WADMKK']}</td></tr>
        </table>`;
      layer.bindPopup(popupContent);

      layer.on({
        mouseover: e => e.target.setStyle(highlightStyle),
        mouseout: e => layer_Indeks.resetStyle(e.target)
      });
    }

    var layer_Indeks = new L.geoJson(json_IndeksKesesuaianLahanPertanian_2, {
      style: style_Indeks,
      onEachFeature: onEach_Indeks
    });

    // ===============================
    // Mayoritas Tutupan Lahan (Fixed opacity)
    // ===============================
    function style_Landcover(feature) {
      switch (Number(feature.properties['landcover'])) {
        case 1: return {color: '#397d49', weight: 0, fillOpacity: 1}; // Trees
        case 4: return {color: '#e49635', weight: 0, fillOpacity: 1}; // Crops
        case 5: return {color: '#dfc35a', weight: 0, fillOpacity: 1}; // Shrub
        case 6: return {color: '#c4281b', weight: 0, fillOpacity: 1}; // Built
        default: return {color: '#cccccc', weight: 0, fillOpacity: 1}; // Others
      }
    }

    var layer_Landcover = new L.geoJson(json_MayoritasTutupanLahan_1, {
      style: style_Landcover
    });

    // ===============================
    // Batas Kabupaten
    // ===============================
    var layer_BatasKabupaten = new L.geoJson(json_BatasKabupaten_4, {
      style: { color: '#000000', weight: 2.5, opacity: 1 }
    });

    // ===============================
    // Kontrol Layer dengan Legenda Terintegrasi
    // ===============================
    var baseMaps = {
      "Google Satellite": layer_GoogleSatellite_0
    };

    // Create custom control with legend
    var overlayControl = L.control.layers(baseMaps, null, {
      collapsed: false,
      position: 'topright'
    });
    
    // Add overlays with legends
    overlayControl.addOverlay(layer_Indeks, `
      <div>
        <span>Indeks Kesesuaian Lahan Pertanian</span>
        <div class="layer-legend">
          <i style="background:#2B83BA"></i> Sangat Sesuai (S1)<br>
          <i style="background:#C7E8AD"></i> Cukup Sesuai (S2)<br>
          <i style="background:#FEC980"></i> Sesuai Marginal (S3)<br>
          <i style="background:#D7191C"></i> Tidak Sesuai (N)
        </div>
      </div>
    `);
    
    overlayControl.addOverlay(layer_Landcover, `
      <div>
        <span>Mayoritas Tutupan Lahan</span>
        <div class="layer-legend">
          <i style="background:#397d49"></i> Hutan<br>
          <i style="background:#e49635"></i> Lahan Pertanian<br>
          <i style="background:#dfc35a"></i> Semak Belukar<br>
          <i style="background:#c4281b"></i> Permukiman
        </div>
      </div>
    `);
    
    overlayControl.addOverlay(layer_BatasKabupaten, "Batas Kabupaten");
    
    // Add control to map
    overlayControl.addTo(map);
    
    // Add all layers by default
    layer_Indeks.addTo(map);
    layer_Landcover.addTo(map);
    layer_BatasKabupaten.addTo(map);
  </script>
</body>
</html>
