<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Peta Kesesuaian Lahan Pertanian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    .leaflet-popup-content table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .leaflet-popup-content th, .leaflet-popup-content td {
      padding: 4px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .legend-panel {
      background: white;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 5px;
      line-height: 20px;
      margin-top: 5px;
    }

    .legend-panel i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 6px;
      opacity: 1;
      border: 1px solid #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="js/leaflet.js"></script>
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>

  <!-- Data JS -->
  <script src="data/MayoritasTutupanLahan_1.js"></script>
  <script src="data/IndeksKesesuaianLahanPertanian_2.js"></script>
  <script src="data/BatasKabupaten_4.js"></script>

  <script>
    const map = L.map('map').fitBounds([[-8.29, 109.98], [-7.45, 110.86]]);
    const hash = new L.Hash(map);

    const basemap = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: "Google Satellite"
    }).addTo(map);

    // ========================
    // Layer: Indeks Kesesuaian
    // ========================
    const defaultStyle = {
      opacity: 1,
      color: '#000',
      weight: 1,
      fillOpacity: 1
    };

    const styleIndeks = feature => {
      const cluster = feature.properties['Cluster'];
      const color = {
        'Sangat Sesuai (S1)': '#2B83BA',
        'Cukup Sesuai (S2)': '#C7E8AD',
        'Sesuai Marginal (S3)': '#FEC980',
        'Tidak Sesuai (N)': '#D7191C'
      }[cluster] || '#cccccc';
      return { ...defaultStyle, fillColor: color };
    };

    const onEachIndeks = (feature, layer) => {
      const p = feature.properties;
      const content = `
        <div class="popup-content">
          <h4>Nama Desa: ${p['NAMOBJ']}</h4>
          <table>
            <tr><th>Kesesuaian</th><td>${p['Cluster']}</td></tr>
            <tr><th>Kabupaten</th><td>${p['WADMKK']}</td></tr>
            <tr><th colspan="2"><hr></th></tr>
            <tr><th>Vegetasi</th><td>${p['Dimensi Ve']}</td></tr>
            <tr><th>Cuaca</th><td>${p['Dimensi Cu']}</td></tr>
            <tr><th>Tanah</th><td>${p['Dimensi Ta']}</td></tr>
            <tr><th>Topografi</th><td>${p['Dimensi To']}</td></tr>
            <tr><th>Aksesibilitas</th><td>${p['Dimensi Ak']}</td></tr>
            <tr><th colspan="2"><hr></th></tr>
            <tr><th>Rekomendasi</th><td>${p['Rekomendas']}</td></tr>
          </table>
        </div>`;
      layer.bindPopup(content, { maxWidth: 300, className: 'custom-popup' });
    };

    const layerIndeks = L.geoJson(json_IndeksKesesuaianLahanPertanian_2, {
      style: styleIndeks,
      onEachFeature: onEachIndeks
    }).addTo(map);

    // ========================
    // Layer: Tutupan Lahan
    // ========================
    const landcoverMap = {
      1: { label: "Hutan", color: '#397d49' },
      4: { label: "Lahan Pertanian", color: '#e49635' },
      5: { label: "Semak Belukar", color: '#dfc35a' },
      6: { label: "Permukiman", color: '#c4281b' }
    };

    const styleLandcover = feature => {
      const val = Number(feature.properties['_majority']);
      const meta = landcoverMap[val] || { color: '#999999' };
      return {
        fillColor: meta.color,
        color: '#333',  // batas desa
        weight: 0.8,
        fillOpacity: 1
      };
    };

    const onEachLandcover = (feature, layer) => {
      const p = feature.properties;
      const lcVal = Number(p['_majority']);
      const lcLabel = landcoverMap[lcVal]?.label || 'Lainnya';
      const content = `
        <table>
          <tr><th>Nama Desa</th><td>${p['NAMOBJ']}</td></tr>
          <tr><th>Kabupaten</th><td>${p['WADMKK']}</td></tr>
          <tr><th>Tutupan Lahan</th><td>${lcLabel}</td></tr>
        </table>`;
      layer.bindPopup(content);
    };

    const layerLandcover = L.geoJson(json_MayoritasTutupanLahan_1, {
      style: styleLandcover,
      onEachFeature: onEachLandcover
    }).addTo(map);

    // ========================
    // Layer: Batas Kabupaten
    // ========================
    const layerBatas = L.geoJson(json_BatasKabupaten_4, {
      style: { color: '#000', weight: 2 }
    }).addTo(map);

    // ========================
    // Layer Control + Legend
    // ========================
    const baseMaps = {
      "Google Satellite": basemap
    };

    const overlayMaps = {
      "Indeks Kesesuaian Lahan Pertanian": layerIndeks,
      "Mayoritas Tutupan Lahan": layerLandcover,
      "Batas Kabupaten": layerBatas
    };

    const layerControl = L.control.layers(baseMaps, overlayMaps, {
      collapsed: false,
      position: 'topright'
    }).addTo(map);

    // ========================
    // Tambahkan Legend (manual di bawah layer)
    // ========================
    const legend = L.control({ position: 'topright' });
    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'legend-panel');
      div.innerHTML = `
        <b>Kesesuaian Lahan</b><br>
        <i style="background:#2B83BA"></i> Sangat Sesuai (S1)<br>
        <i style="background:#C7E8AD"></i> Cukup Sesuai (S2)<br>
        <i style="background:#FEC980"></i> Sesuai Marginal (S3)<br>
        <i style="background:#D7191C"></i> Tidak Sesuai (N)<br><br>
        <b>Tutupan Lahan</b><br>
        <i style="background:#397d49"></i> Hutan<br>
        <i style="background:#e49635"></i> Lahan Pertanian<br>
        <i style="background:#dfc35a"></i> Semak Belukar<br>
        <i style="background:#c4281b"></i> Permukiman
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
